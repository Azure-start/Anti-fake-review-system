# 项目讲解文档
本文面向产品、研发与运维，系统性讲解“区块链电商防刷评系统——前端”的目标、架构、关键模块、数据与交互流、页面说明与开发约定，帮助快速读懂与上手项目。

一、项目概览
- 项目定位：基于区块链的电商应用前端，核心在“真实交易-确认收货-合规评价-链上存证”，以技术手段抑制刷单刷评。
- 技术栈：Vue 3、Element Plus、Pinia、Vue Router 4、Ethers.js、Axios、Vite（详见 [README.md](README.md)）。
- 运行环境与命令：参考 [快速开始指南.md](快速开始指南.md) 与 [README.md](README.md)。
- 最近修改与注意事项：参考 [开发说明.md](开发说明.md) 与 [项目配置说明.md](项目配置说明.md)。

二、目录与模块导览
- 前端入口与全局骨架： [index.html](index.html) ｜ [src/main.js](src/main.js) ｜ [src/App.vue](src/App.vue)
- 路由： [src/router/index.js](src/router/index.js)
- 状态管理： [src/stores/userStore.js](src/stores/userStore.js) 及链路依赖
- 区块链工具： [src/utils/chainHelper.js](src/utils/chainHelper.js)
- 接口与请求： [src/api/request.js](src/api/request.js) 与各 API 模块
- 页面视图： [src/views/](src/views) 下按业务分层（用户、商家、管理员）
- 公共组件： [src/components/](src/components)
- 静态资源与样式： [src/assets/](src/assets)

三、关键设计理念（防刷评闭环）
1) 评价前置条件：必须存在真实订单并已“确认收货”。此机制在近期改造中落地，详见 [开发说明.md](开发说明.md) 与页面 [src/views/Transactions.vue](src/views/Transactions.vue) / [src/views/Review.vue](src/views/Review.vue)。
2) 评价上链：提交评价后产生链上存证与 NFT 标识，结果在页面中回显（示例逻辑见 [submitReview()](src/api/productApi.js:93)）。
3) 激励约束：评价质量与行为与奖励挂钩，示例数据见 [generateMockRewards()](src/api/mockData.js:442)。
4) 降噪策略：后端未就绪时默认走 Mock，前端可完整演示且不弹大量错误（见 [request.interceptors.response.use()](src/api/request.js:30) 与各 API 的开发模式 Mock 策略）。

四、路由与权限模型
- 路由定义：见 [src/router/index.js](src/router/index.js)。全局守卫入口 [router.beforeEach()](src/router/index.js:117)。
- 登录态校验：若目标路由需要登录但用户未连接钱包，将被重定向至登录页（逻辑位于 [router.beforeEach()](src/router/index.js:121)）。
- 角色鉴权：通过路由 meta.requiresRole 与用户角色匹配，逻辑见 [router.beforeEach()](src/router/index.js:130)。
- 角色跳转：无权限时给出提示并按当前角色回落到对应首页（处理见 [router.beforeEach()](src/router/index.js:135)）。
- 主要路由：用户端（首页、详情、下单、交易、评价、奖励、账户）、商家端（店铺管理、商品管理、订单）、管理员端（仪表盘、用户、商家审核）。

五、状态管理（Pinia）
- 用户仓库： [useUserStore()](src/stores/userStore.js:4)
  - 关键状态：walletAddress、token、balance、rewardBalance、isConnected、userRole、shopInfo
  - 初始化恢复本地缓存： [initStore()](src/stores/userStore.js:26)
  - 登录态与令牌： [setToken()](src/stores/userStore.js:56) ｜ 退出清理： [logout()](src/stores/userStore.js:93)
  - 衍生状态：地址格式化 [formattedAddress](src/stores/userStore.js:15)，角色判断 [isUser](src/stores/userStore.js:20)/[isMerchant](src/stores/userStore.js:21)/[isAdmin](src/stores/userStore.js:22)
- 链路：钱包连接后将更新余额与连接状态，联动路由守卫与页面渲染。

六、区块链交互（Ethers.js）
- 工具封装： [src/utils/chainHelper.js](src/utils/chainHelper.js)
  - Provider 获取： [getProvider()](src/utils/chainHelper.js:17)
  - 网络检测： [checkNetwork()](src/utils/chainHelper.js:27)
  - 网络切换： [switchNetwork()](src/utils/chainHelper.js:53)
  - 余额查询： [getBalance()](src/utils/chainHelper.js:106)
- 网络策略：当前默认不强制切换网络，连接钱包时沿用 MetaMask 当前网络；如需恢复自动切换，参考 [开发说明.md](开发说明.md) 指引调整 [src/components/WalletConnectBtn.vue](src/components/WalletConnectBtn.vue) 中相关注释段。

七、钱包连接与登录
- 入口组件： [src/components/WalletConnectBtn.vue](src/components/WalletConnectBtn.vue)
  - 用户动作：点击“连接钱包”触发 [handleConnect()](src/components/WalletConnectBtn.vue:96)
  - 签名登录：逻辑封装于 [signInWallet()](src/components/WalletConnectBtn.vue:192)，后端未启动时会优雅降级（仅连接钱包，不强依赖后端）
  - 下拉菜单：由 [handleCommand()](src/components/WalletConnectBtn.vue:221) 统一处理“账户/交易/奖励/切角色/断开”等
- 连接流程摘要：
  1. 通过 [getProvider()](src/utils/chainHelper.js:17) 请求账户地址
  2.（可选）检测/切换网络 [checkNetwork()](src/utils/chainHelper.js:27) / [switchNetwork()](src/utils/chainHelper.js:53)
  3. 查询余额 [getBalance()](src/utils/chainHelper.js:106)
  4. 调用 [signInWallet()](src/components/WalletConnectBtn.vue:192) 获取 nonce、签名并交换 token（若后端就绪）
  5. 持久化地址与 token（见 [setWalletAddress()](src/stores/userStore.js:50) 与 [setToken()](src/stores/userStore.js:56)）

八、HTTP 请求与错误处理
- Axios 实例： [axios.create()](src/api/request.js:6)
- 请求拦截：注入 Authorization 头，见 [request.interceptors.request.use()](src/api/request.js:12)
- 响应拦截：统一处理后端 {code, data, message} 结构与 HTTP 错误，见 [request.interceptors.response.use()](src/api/request.js:30)
- 开发期降噪：开发模式避免频繁弹错，更多以 console.warn 形式输出，便于在后端未启动时完整演示（详见 [src/api/request.js](src/api/request.js)）。

九、API 模块与 Mock 机制
- 产品 API： [src/api/productApi.js](src/api/productApi.js)
  - 列表： [getProductList()](src/api/productApi.js:11)（支持分页/搜索；开发模式走 Mock）
  - 详情： [getProductDetail()](src/api/productApi.js:47)
  - 评价列表： [getProductReviews()](src/api/productApi.js:72)
  - 发布评价： [submitReview()](src/api/productApi.js:93)（返回示例 nftId 与 txHash）
- Mock 数据源： [src/api/mockData.js](src/api/mockData.js)
  - 商品示例： [mockProducts](src/api/mockData.js:56)
  - 交易记录生成： [generateMockTransactions()](src/api/mockData.js:381)
  - 奖励记录生成： [generateMockRewards()](src/api/mockData.js:442)
  - 优惠券生成： [generateMockCoupons()](src/api/mockData.js:484)
- 机制说明：默认以 import.meta.env.MODE === 'development' 作为开关；后端未就绪亦可全链路演示，避免阻塞前端开发。

十、页面说明（选摘）
- 首页 Home：商品列表与搜索，数据源同 [getProductList()](src/api/productApi.js:11)（文件： [src/views/Home.vue](src/views/Home.vue)）
- 商品详情：展示图片、规格、评分与评价列表（文件： [src/views/ProductDetail.vue](src/views/ProductDetail.vue)；评价数据见 [getProductReviews()](src/api/productApi.js:72)）
- 下单与支付：确认订单、填写地址、发起支付与状态反馈（文件： [src/views/Checkout.vue](src/views/Checkout.vue)）
- 交易记录：查询交易状态、执行“确认收货”（文件： [src/views/Transactions.vue](src/views/Transactions.vue)；与防刷评强相关）
- 发布评价：评分/文案/图片校验与“上链存证”（文件： [src/views/Review.vue](src/views/Review.vue)；提交逻辑示例 [submitReview()](src/api/productApi.js:93)）
- 奖励与账户：展示奖励余额/记录与个人信息统计（文件： [src/views/Rewards.vue](src/views/Rewards.vue) / [src/views/Account.vue](src/views/Account.vue)）
- 商家端：店铺管理/商品管理/订单管理（目录： [src/views/merchant/](src/views/merchant)）
- 管理员端：系统概览/用户管理/商家审核（目录： [src/views/admin/](src/views/admin)）

十一、角色与导航体验
- 初始角色为“用户”。完成钱包连接后，组件将友好询问是否切换为“商家”（详见 [handleConnect()](src/components/WalletConnectBtn.vue:159) 附近流程）。
- 角色值来源与持久化： [setUserRole()](src/stores/userStore.js:77)，并受路由 meta.requiresRole 保护（见 [router.beforeEach()](src/router/index.js:130)）。
- 断开连接： [handleDisconnect()](src/components/WalletConnectBtn.vue:246) 清理本地状态并回到首页。

十二、配置与环境
- 依赖与脚本： [package.json](package.json)
- 构建与本地开发：Vite，命令见 [README.md](README.md)
- 环境变量：.env.* 中的 VITE_API_BASE_URL、VITE_CHAIN_ID、VITE_CHAIN_NAME（示例见 [README.md](README.md)）
- 代理与跨域：开发环境通过 Vite 代理；生产需配合后端 CORS（细节见 [项目配置说明.md](项目配置说明.md) 与 [vite.config.js](vite.config.js)）

十三、错误处理与用户体验
- 友好降级：后端未就绪时不打断主要交互，错误通过控制台警告输出，避免密集弹窗（核心在 [request.interceptors.response.use()](src/api/request.js:30)）。
- 常见 HTTP 场景：
  - 401：清理登录态并提示（处理位置见 [request.interceptors.response.use()](src/api/request.js:60) 及后续分支）
  - 403/404/500：以 warn 为主，避免误导用户（详见 [src/api/request.js](src/api/request.js)）

十四、安全与合规要点
- 授权：签名登录仅在后端就绪时启用，token 注入位于 [request.interceptors.request.use()](src/api/request.js:12)
- 存储：钱包地址、token 与角色存于 localStorage，登出时统一清理（ [logout()](src/stores/userStore.js:93)）
- 最小权限：前端仅持必要信息，核心交易安全逻辑建议在合约与后端侧落实

十五、性能建议与后续优化
- 路由级懒加载：已启用（见 [src/router/index.js](src/router/index.js) 内动态 import）
- 代码分割与懒加载：持续细化拆分与资源按需加载
- 列表虚拟化与缓存：在商品/评价长列表时按需引入
- 参考 Roadmap：见 [README.md](README.md) “后续优化” 清单

十六、常见问题（FAQ）
Q1：为何连接钱包后没有强制切换到 Sepolia？
A：当前策略是尊重用户在 MetaMask 的网络选择；如需恢复自动切换，请按 [开发说明.md](开发说明.md) 指引，调整 [src/components/WalletConnectBtn.vue](src/components/WalletConnectBtn.vue) 中相关注释段（位于 [handleConnect()](src/components/WalletConnectBtn.vue:110) 附近）。
Q2：后端服务未启动时如何演示？
A：开发模式走 Mock 数据与静默错误处理，功能可全链路演示（见 [src/api/productApi.js](src/api/productApi.js) 与 [src/api/request.js](src/api/request.js)）。
Q3：评价为什么需要“确认收货”？
A：为保障评价真实性，流程要求用户在交易完成并确认收货后才可评价，见 [src/views/Transactions.vue](src/views/Transactions.vue) 与 [src/views/Review.vue](src/views/Review.vue)。

十七、术语表
- Mock：用于开发与演示的本地数据源，见 [src/api/mockData.js](src/api/mockData.js)
- NFT：非同质化代币，本项目用于评价上链存证（生成位置示例见 [submitReview()](src/api/productApi.js:93) 的返回）
- Token（后端颁发）：经签名校验后获得，用于保护业务接口（注入逻辑见 [request.interceptors.request.use()](src/api/request.js:12)）

十八、快速上手清单
- 1）安装依赖并启动开发服务（见 [README.md](README.md)）
- 2）安装并解锁 MetaMask，连接任一测试网络
- 3）点击“连接钱包”，验证基础导航、交易与评价流程（ [WalletConnectBtn.vue](src/components/WalletConnectBtn.vue)）
- 4）切换角色体验商家/管理员端路由与权限控制（ [router.beforeEach()](src/router/index.js:117)）
- 5）若需联通后端，配置 [VITE_API_BASE_URL](README.md) 并启动后端服务

附：相关文件清单（便于检索）
- 总览与指南： [README.md](README.md) ｜ [快速开始指南.md](快速开始指南.md) ｜ [开发说明.md](开发说明.md) ｜ [项目配置说明.md](项目配置说明.md) ｜ [开发完成总结.md](开发完成总结.md)
- 路由： [src/router/index.js](src/router/index.js)
- 状态： [src/stores/userStore.js](src/stores/userStore.js)
- 区块链： [src/utils/chainHelper.js](src/utils/chainHelper.js)
- 网络请求： [src/api/request.js](src/api/request.js)
- API 示例： [src/api/productApi.js](src/api/productApi.js) ｜ [src/api/mockData.js](src/api/mockData.js)
- 组件： [src/components/WalletConnectBtn.vue](src/components/WalletConnectBtn.vue)
- 视图： [src/views/](src/views)

结语
本文覆盖了项目核心理念与模块关系，建议结合源码链接逐段阅读、运行体验，再配合现有文档完成配置与联调，可在短时间内完成从“读懂”到“上手”的闭环。